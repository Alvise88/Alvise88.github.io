<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Swarm Ingresses | Alvise's Blog</title><meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="In Kubernetes, we would consider a “service” to be a network entity that makes it possible to reach individual containers.
In Swarm, however, a “service” means something completely different.
A Swarm service is the equivalent of a container and all of the information needed to instantiate and run it.
For example:
version: '3' networks: default: external: false services: whoami: image: traefik/whoami networks: - default deploy: replicas: 3There are two types of Swarm services.">
<meta name=generator content="Hugo 0.93.2">
<meta name=robots content="noindex, nofollow">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Swarm Ingresses">
<meta property="og:description" content="In Kubernetes, we would consider a “service” to be a network entity that makes it possible to reach individual containers.
In Swarm, however, a “service” means something completely different.
A Swarm service is the equivalent of a container and all of the information needed to instantiate and run it.
For example:
version: '3' networks: default: external: false services: whoami: image: traefik/whoami networks: - default deploy: replicas: 3There are two types of Swarm services.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://Alvise88.github.io/posts/swarm-ingresses/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-03-07T06:36:47+00:00">
<meta property="article:modified_time" content="2022-03-07T06:36:47+00:00">
<meta itemprop=name content="Swarm Ingresses">
<meta itemprop=description content="In Kubernetes, we would consider a “service” to be a network entity that makes it possible to reach individual containers.
In Swarm, however, a “service” means something completely different.
A Swarm service is the equivalent of a container and all of the information needed to instantiate and run it.
For example:
version: '3' networks: default: external: false services: whoami: image: traefik/whoami networks: - default deploy: replicas: 3There are two types of Swarm services."><meta itemprop=datePublished content="2022-03-07T06:36:47+00:00">
<meta itemprop=dateModified content="2022-03-07T06:36:47+00:00">
<meta itemprop=wordCount content="1203">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Swarm Ingresses">
<meta name=twitter:description content="In Kubernetes, we would consider a “service” to be a network entity that makes it possible to reach individual containers.
In Swarm, however, a “service” means something completely different.
A Swarm service is the equivalent of a container and all of the information needed to instantiate and run it.
For example:
version: '3' networks: default: external: false services: whoami: image: traefik/whoami networks: - default deploy: replicas: 3There are two types of Swarm services.">
</head><body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
Alvise's Blog
</a>
<div class="flex-l items-center">
<ul class="pl0 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/posts/ title="Posts page">
Posts
</a>
</li></ul><div class=ananke-socials>
<a href=https://www.linkedin.com/in/alvisevitturi target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window">
<span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</span>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</span></a>
</div></div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside><div id=sharing class="mt3 ananke-socials">
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://Alvise88.github.io/posts/swarm-ingresses/&title=Swarm%20Ingresses" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn">
<span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</span>
</a>
</div><h1 class="f1 athelas mt3 mb1">Swarm Ingresses</h1><time class="f6 mv4 dib tracked" datetime=2022-03-07T06:36:47Z>March 7, 2022</time>
</header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>In Kubernetes, we would consider a “service” to be a network entity that makes it possible to reach individual containers.<br>
In Swarm, however, a “service” means something completely different.</p><p>A Swarm service is the equivalent of a container and all of the information needed to instantiate and run it.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>version: <span style=color:#e6db74>&#39;3&#39;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    default:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    external: false<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    whoami:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>       image: traefik/whoami<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - default<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    deploy:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      replicas: <span style=color:#ae81ff>3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>There are two types of Swarm services. Replicated services are instantiated as many times as you’ve requested.<br>
If you ask for three of a replicated service, you get three.<br>
If you ask for 10, you get 10, and so on.<br>
Global services, on the other hand, are like Kubernetes DaemonSets, in that you have one instance running on each node.</p><p>As an orchestration engine, Docker Swarm decides where to put workloads, and then manages requests for those workloads. Swarm allows you to use multiple load balancing mechanisms, including Spread, which tries to keep the usage of each node as low as possible, and BinPack, which tries to use as few servers as possible to handle requests from within the cluster.</p><p>Internally, Swarm assigns each service its own DNS entry, and when it receives a request for that entry, it load balances requests between different nodes hosting that service.</p><p>Although Docker is included with environments aimed at developers, such as Docker Desktop, it’s also available for production environments.</p><p>One of the advantages of working with Docker Swarm is that developers can use the exact same artifacts — including the stack definition — in both their development and production environments.</p><p>In the last few years, there were some rumors in regards to Docker Swarm and the future of that technology.
However, based on the news published recently we can assume that Docker Swarm will be still supported.</p><p>I don’t tell you that you have to use Docker Swarm. This is one of the options you choose among a few available orchestration tools.</p><p>You can leverage Docker Swarm by installing <a href=https://doc.traefik.io/traefik/>Traefik</a> that is an open-source router for microservice architectures and that article shows how to use those tools together.</p><p>Basically speaking Traefik can be considered an ingress controller for Swarm.</p><p>By the end of 2019, there was a release of Traefik 2 that introduces a few crucial changes. The most important is to change the naming of key features of the system. If you are familiar with Traefik v.1 you probably know to name such as fronted, backend and rules.</p><p>In V 2 we have:</p><ul>
<li>router that replaced fronted</li><li>service that replaced backend</li><li>middleware that replaced rules</li></ul><p>Using traefik with swarm allows you to define ingresses dynamically.</p><p>The idea is to have a main load balancer/proxy that covers all the Docker Swarm cluster and handles HTTPS certificates and requests for each domain.</p><p>But doing it in a way that allows you to have other Traefik services inside each stack without interfering with each other, to redirect based on path in the same stack (e.g. one container handles / for a web frontend and another handles /api for an API under the same domain), or to redirect from HTTP to HTTPS selectively.</p><p>Preparation:</p><ul>
<li>
<p>Connect via SSH to a manager node in your cluster (you might have only one node) that will have the Traefik service.</p></li><li>
<p>Create a network that will be shared with Traefik and the containers that should be accessible from the outside, with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker network create --driver<span style=color:#f92672>=</span>overlay traefik-public
</span></span></code></pre></div></li><li>
<p>Create an environment variable with a username (you will use it for the HTTP Basic Auth for Traefik and Consul UIs), for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export USERNAME<span style=color:#f92672>=</span>admin
</span></span></code></pre></div></li><li>
<p>Create an environment variable with the password, e.g.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export PASSWORD<span style=color:#f92672>=</span>s3cret
</span></span></code></pre></div></li><li>
<p>Use openssl to generate the &ldquo;hashed&rdquo; version of the password and store it in an environment variable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export HASHED_PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl passwd -apr1 $PASSWORD<span style=color:#66d9ef>)</span>
</span></span></code></pre></div></li><li>
<p>Create a compose file called traefik.yml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>version: <span style=color:#e6db74>&#34;3.8&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>x-default-opts: &amp;default-opts<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  logging:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    driver: <span style=color:#e6db74>&#34;json-file&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    options:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      max-size: <span style=color:#e6db74>&#34;10m&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      max-file: <span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>x-constraints: &amp;constraints<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e># - node.role == worker</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  - node.platform.os <span style=color:#f92672>==</span> linux<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e># - node.labels.datacenter == ponzano</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>x-preferences: &amp;preferences<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  - spread: node.labels.datacenter<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  traefik-public:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    external: true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>configs:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  routers-config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    name: routers-config-<span style=color:#e6db74>${</span>CONFIG<span style=color:#66d9ef>:-</span>1<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    file: ./conf.d/routers.toml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  middlewares-config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    name: middlewares-config-<span style=color:#e6db74>${</span>CONFIG<span style=color:#66d9ef>:-</span>1<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    file: ./conf.d/middlewares.toml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  tls-config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    name: tls-config-<span style=color:#e6db74>${</span>CONFIG<span style=color:#66d9ef>:-</span>1<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    file: ./conf.d/tls.toml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  canary-config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    name: canary-config-<span style=color:#e6db74>${</span>CONFIG<span style=color:#66d9ef>:-</span>1<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    file: ./conf.d/canary.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  traefik-config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    name: traefik-config-<span style=color:#e6db74>${</span>CONFIG<span style=color:#66d9ef>:-</span>1<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    file: ./traefik.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  traefik:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    &lt;&lt;: *default-opts<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e># The official v2.6.1 Traefik docker image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: traefik:v2.6.1<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    healthcheck:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      test: traefik healthcheck --ping<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      interval: 10s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      timeout: 5s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      retries: <span style=color:#ae81ff>3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      start_period: 45s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ports:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#75715e># The HTTP port</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#e6db74>&#34;80:80&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#e6db74>&#34;443:443&#34;</span> <span style=color:#75715e>#Docker sends requests on port 443 to Traefik on port 443</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#e6db74>&#34;8080:8080&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#e6db74>&#34;8082:8082&#34;</span> <span style=color:#75715e>#Traefik metrics</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - traefik-public<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  configs:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#75715e># Dynamic config</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - source: routers-config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        target: /conf.d/routers.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        mode: <span style=color:#ae81ff>0400</span> <span style=color:#75715e>#Read only</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - source: middlewares-config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        target: /conf.d/middlewares.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        mode: <span style=color:#ae81ff>0400</span> <span style=color:#75715e>#Read only</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - source: tls-config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        target: /conf.d/tls.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        mode: <span style=color:#ae81ff>0400</span> <span style=color:#75715e>#Read only</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - source: canary-config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        target: /conf.d/canary.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        mode: <span style=color:#ae81ff>0400</span> <span style=color:#75715e>#Read only</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#75715e># Static config</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - source: traefik-config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        target: /traefik.yml<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        mode: <span style=color:#ae81ff>0400</span> <span style=color:#75715e>#Read only</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    deploy:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      placement:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        preferences: *preferences<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        constraints: *constraints<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      update_config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># https://docs.docker.com/compose/compose-file/#update_config</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        parallelism: <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        delay: 30s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        monitor: 60s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        failure_action: rollback<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        max_failure_ratio: <span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        order: stop-first<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      rollback_config:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        parallelism: <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        delay: 30s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        failure_action: <span style=color:#66d9ef>continue</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        monitor: 60s<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        max_failure_ratio: <span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        order: stop-first<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      labels:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Enable Traefik for this service, to make it available in the public network</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.enable<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.docker.lbswarm<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Use the traefik-public network (declared below)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.docker.network<span style=color:#f92672>=</span>traefik-public<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Use the custom label &#34;traefik.constraint-label=traefik-public&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># This public Traefik will only use services with this label</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># That way you can add other internal Traefik instances per stack if needed</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># - traefik.constraint-label=traefik-edge</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># admin-auth middleware with HTTP Basic auth</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Using the environment variables USERNAME and HASHED_PASSWORD</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        traefik.http.middlewares.admin-auth.basicauth.users<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>USERNAME?Variable not set<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>HASHED_PASSWORD?Variable not set<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># https-redirect middleware to redirect HTTP to HTTPS</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># It can be re-used by other stacks in other Docker Compose files</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.middlewares.https-redirect.redirectscheme.scheme=https</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.middlewares.https-redirect.redirectscheme.permanent=true</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># traefik-http set up only to use the middleware to redirect to https</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Uses the environment variable DOMAIN</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.routers.traefik-edge-http.rule<span style=color:#f92672>=</span>Host<span style=color:#f92672>(</span><span style=color:#e6db74>`</span>traefik.swarm.dev<span style=color:#e6db74>`</span><span style=color:#f92672>)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.routers.traefik-edge-http.entrypoints<span style=color:#f92672>=</span>http<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.routers.traefik-edge-http.middlewares<span style=color:#f92672>=</span>admin-auth<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.routers.traefik-edge.service<span style=color:#f92672>=</span>api@internal<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-http.middlewares=https-redirect</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># traefik-https the actual router using HTTPS</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Uses the environment variable DOMAIN</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.rule=Host(`traefik.swarm.dev`)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.entrypoints=https</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.tls=true</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Use the special Traefik service api@internal with the web UI/Dashboard</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.service=api@internal</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Use the &#34;le&#34; (Let&#39;s Encrypt) resolver created below</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.tls.certresolver=le</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Enable HTTP Basic auth, using the middleware created above</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e>##- traefik.http.routers.traefik-edge-https.middlewares=admin-auth</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#75715e># Define the port inside of the Docker service to use</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.services.traefik-edge.loadbalancer.server.port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.services.traefik-edge.loadbalancer.sticky<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.services.traefik-edge.loadbalancer.sticky.cookie.name<span style=color:#f92672>=</span>traefik_xxx_cookie<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.services.traefik-edge.loadbalancer.sticky.cookie.httpOnly<span style=color:#f92672>=</span>true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - traefik.http.services.traefik-edge.loadbalancer.sticky.cookie.secure<span style=color:#f92672>=</span>false<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></li><li>
<p>Deploy the stack with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker stack deploy -c traefik.yml traefik
</span></span></code></pre></div></li><li>
<p>Check if the stack was deployed with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker stack ps traefik
</span></span></code></pre></div></li><li>
<p>It will output something like:</p><pre tabindex=0><code>ID             NAME                IMAGE          NODE              DESIRED STATE   CURRENT STATE          ERROR   PORTS
w5o6fmmln8ni   traefik_traefik.1   traefik:v2.6.1 dog.example.com   Running         Running 1 minute ago
</code></pre></li><li>
<p>You can check the Traefik logs with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker service logs traefik_traefik
</span></span></code></pre></div></li></ul><p>The next thing would be to deploy a stack (a complete web application, with backend, frontend, database, etc) using this Docker Swarm mode cluster.</p><p>It&rsquo;s actually very simple, as you can use Docker Compose for local development and then use the same files for deployment in the Docker Swarm mode cluster.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span>networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  traefik-public:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    external: true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  whoami:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    image: traefik/whoami<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    networks:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - traefik-public<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    deploy:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      labels:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.docker.lbswarm=true&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.docker.network=traefik-public&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.http.routers.whoami_whoami.rule=Host(`whoami.swarm.dev`)&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.http.routers.whoami_whoami.entrypoints=http&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.http.routers.whoami_whoami.service=whoami_whoami&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        - <span style=color:#e6db74>&#34;traefik.http.services.whoami_whoami.loadbalancer.server.port=80&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Once you have made the decision to make the leap towards k8s you can continue to use traefik installing it using the <a href=https://github.com/traefik/traefik-helm-chart>Traefik Helm Chart</a></p><ul class=pa0>
</ul><div class="mt6 instapaper_ignoref">
</div></div><aside class="w-30-l mt6-l">
</aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://Alvise88.github.io>
&copy; Alvise's Blog 2022
</a>
<div>
<div class=ananke-socials>
<a href=https://www.linkedin.com/in/alvisevitturi target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window">
<span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</span>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</span></a>
</div></div></div></footer></body></html>